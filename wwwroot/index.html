<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Инвестиционная платформа</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .integration-flow {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .flow-step {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
        }

        .flow-number {
            background: white;
            color: #667eea;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }

        input, select, button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

            button:hover {
                background: #0056b3;
            }

        .result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f8f9fa;
            white-space: pre-line;
        }

        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .notification {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            color: #856404;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active {
            background: #28a745;
        }

        .status-inactive {
            background: #dc3545;
        }

        .api-status {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
        }

        .price-ticker {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: #fff;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .ticker-item {
            padding: 8px 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e9ecef;
            font-weight: bold;
        }

        .price-up {
            color: #28a745;
        }

        .price-down {
            color: #dc3545;
        }

        .tracking-info {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            color: #1565c0;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <h1>Инвестиционная платформа</h1>
    <div id="priceTicker" class="price-ticker"></div>

    <div class="integration-flow">
        <h3>Схема работы</h3>
        <div class="flow-step">
            <div class="flow-number">1</div>
            <div>Создайте операцию покупки акций с указанием email</div>
        </div>
        <div class="flow-step">
            <div class="flow-number">2</div>
            <div>Установите целевую цену для триггера</div>
        </div>
        <div class="flow-step">
            <div class="flow-number">3</div>
            <div>При срабатывании триггера письмо будет отправлено на указанный email</div>
        </div>
    </div>

    <div class="dashboard">
        <!-- Левая колонка -->
        <div>
            <div class="section">
                <h3>Статус сервисов</h3>
                <div class="api-status">
                    <span>Investment API:</span>
                    <span><span class="status-indicator" id="investmentStatusIndicator"></span> <span id="investmentStatusText">Проверка...</span></span>
                </div>
                <div class="api-status">
                    <span>Email Service:</span>
                    <span><span class="status-indicator" id="emailServiceStatusIndicator"></span> <span id="emailServiceStatusText">Проверка...</span></span>
                </div>
                <button onclick="checkServices()">Проверить статус</button>
            </div>

            <div class="section">
                <h3>Калькулятор операции</h3>
                <select id="calcSecurityId">
                    <option value="">Выберите бумагу</option>
                </select>
                <input type="number" id="calcQuantity" placeholder="Количество" value="10">
                <input type="number" id="calcCurrentPrice" placeholder="Текущая цена" step="0.01" readonly>
                <input type="number" id="calcCommission" placeholder="Комиссия" value="5.00" step="0.01">
                <button onclick="calculate()">Рассчитать стоимость</button>
                <div id="calcResult" class="result"></div>
            </div>
        </div>

        <!-- Правая колонка -->
        <div>
            <div class="section">
                <h3>Новая операция с уведомлением</h3>
                <div class="notification" style="margin-bottom: 15px;">
                    <strong>Важно:</strong> Email будет сохранен вместе с операцией и использован для уведомлений о триггерах
                </div>
                <select id="opSecurityId">
                    <option value="">Выберите бумагу</option>
                </select>
                <input type="number" id="opQuantity" placeholder="Количество" value="10">
                <input type="number" id="opPrice" placeholder="Цена покупки" step="0.01">
                <input type="number" id="opCommission" placeholder="Комиссия" value="5.00" step="0.01">
                <input type="number" id="opTargetPrice" placeholder="Целевая цена для триггера" step="0.01">
                <input type="email" id="opEmail" placeholder="Email для уведомления" value="kuzminovdaniil4@gmail.com">
                <button onclick="addOperationWithEmail()" style="background: #28a745;">Добавить операцию с уведомлением</button>
                <div id="opResult" class="result"></div>
            </div>

            <div class="section">
                <h3>Активные триггеры</h3>
                <div id="trackingInfo" class="notification tracking-info" style="margin-bottom: 10px;">
                    <strong>Отслеживание уведомлений:</strong><br>
                     Всего отслеживается: <strong id="trackingCount">0</strong> уведомлений<br>
                     Автопроверка: каждые 30 секунд
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button onclick="getActiveTriggers()" style="flex: 1;">Обновить список</button>
                    <button onclick="checkTriggersAndSendEmails()" style="background: #28a745; flex: 1;">Проверить триггеры сейчас</button>
                    <button onclick="clearNotificationsHistory()" style="background: #9c27b0; flex: 1;">Очистить историю</button>
                </div>
                <div id="triggersResult" class="result"></div>
            </div>
        </div>
    </div>

    <div class="section">
        <h3>История операций</h3>
        <button onclick="getOperations()">Обновить историю</button>
        <div id="operationsResult" class="result"></div>
    </div>

    <script>
        const INVESTMENT_API = 'https://localhost:7006/api/investment';
        const EMAIL_API = 'http://neapiemail2-daniil465346.amvera.io';
        let securities = [];
        let sentNotifications = new Set();

        // ========== УНИВЕРСАЛЬНЫЕ ФУНКЦИИ ==========
        const $ = id => document.getElementById(id);
        const showResult = (elementId, message, isSuccess) => {
            const el = $(elementId);
            if (el) {
                el.innerHTML = message;
                el.className = `result ${isSuccess ? 'success' : 'error'}`;
            }
        };

        const showToast = (message, type = 'info') => {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        background: ${type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#2196f3'};
        color: white;
        border-radius: 5px;
        z-index: 1000;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        animation: slideIn 0.3s ease;
    `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };

        const apiCall = async (url, options = {}) => {
            try {
                const defaultHeaders = {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                };

                const response = await fetch(url, {
                    headers: defaultHeaders,
                    ...options
                });

                if (response.ok) {
                    // Для пустых ответов (например, POST без возвращаемого тела)
                    if (response.status === 204 || response.headers.get('content-length') === '0') {
                        return { success: true };
                    }
                    return await response.json();
                }

                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            } catch (error) {
                console.error(`API Error (${url}):`, error);
                throw error;
            }
        };

        // ========== EMAIL ФУНКЦИИ ==========
        const sendEmailAPI = async (toEmail, subject, message) => {
            try {
                const response = await fetch(`${EMAIL_API}/sendEmail`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        toEmail: toEmail,
                        subject: subject,
                        text: message
                    })
                });

                if (response.status === 201 || response.status === 200) {
                    return { success: true, message: 'Письмо отправлено' };
                } else {
                    const errorText = await response.text();
                    return { success: false, message: `Ошибка ${response.status}: ${errorText}` };
                }
            } catch (error) {
                console.error('Email API error:', error);
                return { success: false, message: `Сетевая ошибка: ${error.message}` };
            }
        };

        // ========== ЛОКАЛЬНОЕ ХРАНИЛИЩЕ ==========
        const loadSentNotifications = () => {
            try {
                const saved = localStorage.getItem('sentNotifications');
                if (saved) sentNotifications = new Set(JSON.parse(saved));
                updateTrackingCount();
            } catch { sentNotifications = new Set(); }
        };

        const saveSentNotifications = () => {
            localStorage.setItem('sentNotifications', JSON.stringify([...sentNotifications]));
            updateTrackingCount();
        };

        const updateTrackingCount = () => {
            const el = $('trackingCount');
            if (el) el.textContent = sentNotifications.size;
        };

        const cleanupOldNotifications = () => {
            const twentyFourHoursAgo = Date.now() - 86400000;
            const filtered = [...sentNotifications].filter(id => {
                const timestamp = parseInt(id.split('_')[3] || 0);
                return timestamp > twentyFourHoursAgo;
            });
            if (filtered.length !== sentNotifications.size) {
                sentNotifications = new Set(filtered);
                saveSentNotifications();
            }
        };

        const createTriggerId = (operationId, securityTicker, triggeredAt) =>
            `trigger_${operationId}_${securityTicker}_${new Date(triggeredAt).getTime()}`;

        // ========== РАСЧЕТЫ ==========
        const calculateOperationCost = async (operationData, currentPrice) => {
            try {
                const result = await apiCall(`${INVESTMENT_API}/calculate`, {
                    method: 'POST',
                    body: JSON.stringify({
                        securityId: operationData.securityId,
                        quantity: operationData.quantity,
                        purchasePricePerShare: currentPrice,
                        commission: operationData.commission || 5.00,
                        targetBuyPrice: operationData.targetBuyPrice || null
                    })
                });
                return {
                    totalCost: result.totalCost || result.TotalCost || result.total || result.cost || 0,
                    hasTrigger: result.hasTrigger || false,
                    triggerMessage: result.triggerMessage || '',
                    calculatedWithApi: true,
                    details: result.details || 'Расчет выполнен через Investment API'
                };
            } catch {
                return {
                    totalCost: operationData.totalCost || (operationData.quantity * currentPrice + (operationData.commission || 5.00)),
                    hasTrigger: !!operationData.targetBuyPrice,
                    triggerMessage: operationData.targetBuyPrice ? `Триггер: $${operationData.targetBuyPrice}` : '',
                    calculatedWithApi: false,
                    details: 'Использованы данные из операции'
                };
            }
        };

        // ========== ЗАГРУЗКА ДАННЫХ ==========
        const loadSecurities = async () => {
            try {
                securities = await apiCall(`${INVESTMENT_API}/securities`);
                ['calcSecurityId', 'opSecurityId'].forEach(id => {
                    const select = $(id);
                    select.innerHTML = '<option value="">Выберите бумагу</option>' +
                        securities.map(s =>
                            `<option value="${s.id}">${s.ticker} - $${s.currentPrice}</option>`
                        ).join('');
                    select.onchange = () => updatePriceOnSelect(select);
                });
            } catch (error) {
                console.error('Ошибка загрузки бумаг:', error);
            }
        };

        const updatePriceOnSelect = (selectElement) => {
            const security = securities.find(s => s.id == selectElement.value);
            if (security) {
                const priceField = $(selectElement.id === 'calcSecurityId' ? 'calcCurrentPrice' : 'opPrice');
                if (priceField) priceField.value = security.currentPrice;
            }
        };

        const updatePricesInRealTime = async () => {
            try {
                const data = await apiCall(`${INVESTMENT_API}/current-prices`);
                const priceItems = data.Prices || data.prices || [];

                priceItems.forEach(p => {
                    const sec = securities.find(s => s.id == (p.Id || p.id));
                    if (sec) sec.currentPrice = Number((p.CurrentPrice || p.currentPrice || 0).toFixed(2));
                });

                const tickerEl = $('priceTicker');
                if (tickerEl) tickerEl.innerHTML = securities.map(s =>
                    `<div class="ticker-item">${s.ticker}: $${Number(s.currentPrice).toFixed(2)}</div>`
                ).join('');

                updateDropdownPrices();
                updateSelectedPriceFields();
            } catch (error) {
                console.error('Ошибка обновления цен:', error);
            }
        };

        const updateDropdownPrices = () => {
            ['calcSecurityId', 'opSecurityId'].forEach(id => {
                const select = $(id);
                const selected = select.value;
                [...select.options].forEach(opt => {
                    if (opt.value) {
                        const sec = securities.find(s => s.id == opt.value);
                        if (sec) opt.textContent = `${sec.ticker} - $${sec.currentPrice}`;
                    }
                });
                select.value = selected;
            });
        };

        const updateSelectedPriceFields = () => {
            const updateField = (selectId, fieldId) => {
                const select = $(selectId);
                const sec = securities.find(s => s.id == select?.value);
                const field = $(fieldId);
                if (sec && field) field.value = sec.currentPrice;
            };
            updateField('calcSecurityId', 'calcCurrentPrice');
            updateField('opSecurityId', 'opPrice');
        };

        // ========== СТАТУС СЕРВИСОВ ==========
        const checkServices = async () => {
            const updateStatus = async (api, indicatorId, textId) => {
                try {
                    // Для Email Service используем POST с тестовыми данными
                    if (api.includes('sendEmail')) {
                        const testData = {
                            toEmail: "test@example.com",
                            subject: "Status Check",
                            text: "Service status check"
                        };
                        const response = await fetch(api, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(testData)
                        });
                        const ok = response.status === 201 || response.ok;
                        $(indicatorId).className = `status-indicator ${ok ? 'status-active' : 'status-inactive'}`;
                        $(textId).textContent = ok ? 'Online' : 'Offline';
                        return ok;
                    } else {
                        // Для Investment API используем GET
                        const response = await fetch(api, { method: 'GET' });
                        const ok = response.ok;
                        $(indicatorId).className = `status-indicator ${ok ? 'status-active' : 'status-inactive'}`;
                        $(textId).textContent = ok ? 'Online' : 'Offline';
                        return ok;
                    }
                } catch {
                    $(indicatorId).className = 'status-indicator status-inactive';
                    $(textId).textContent = 'Offline';
                    return false;
                }
            };

            const [investmentOk, emailOk] = await Promise.all([
                updateStatus(`${INVESTMENT_API}/securities`, 'investmentStatusIndicator', 'investmentStatusText'),
                updateStatus(`${EMAIL_API}/sendEmail`, 'emailServiceStatusIndicator', 'emailServiceStatusText')
            ]);

            showToast(investmentOk && emailOk ? 'Все сервисы работают!' : 'Некоторые сервисы недоступны',
                investmentOk && emailOk ? 'success' : 'error');
        };

        // ========== ОПЕРАЦИИ И ТРИГГЕРЫ ==========
        const addOperationWithEmail = async () => {
            const getValue = id => $(id).value;
            const securityId = getValue('opSecurityId');
            const quantity = getValue('opQuantity');
            const price = getValue('opPrice');
            const email = getValue('opEmail').trim();

            if (!securityId || !email.includes('@') || quantity <= 0 || price <= 0) {
                return showResult('opResult', ' Проверьте обязательные поля', false);
            }

            const operation = {
                securityId: parseInt(securityId),
                quantity: parseInt(quantity),
                purchasePricePerShare: parseFloat(price),
                commission: parseFloat(getValue('opCommission') || 5.00),
                targetBuyPrice: getValue('opTargetPrice') ? parseFloat(getValue('opTargetPrice')) : null,
                notificationEmail: email
            };

            try {
                const result = await apiCall(`${INVESTMENT_API}/operation`, {
                    method: 'POST',
                    body: JSON.stringify(operation)
                });

                const sec = securities.find(s => s.id == securityId);
                let message = `Операция успешно создана!\n\nБумага: ${sec?.ticker}\nКоличество: ${quantity}\nЦена: $${parseFloat(price).toFixed(2)}`;
                if (operation.targetBuyPrice) message += `\nТриггер: $${operation.targetBuyPrice.toFixed(2)}\nEmail: ${email}`;

                showResult('opResult', message, true);
                localStorage.setItem('lastUsedEmail', email);
                getOperations();
                getActiveTriggers();
            } catch (error) {
                showResult('opResult', `❌ Ошибка: ${error.message}`, false);
            }
        };

        const checkTriggersAndSendEmails = async () => {
            try {
                const [operations, triggerHistory] = await Promise.all([
                    apiCall(`${INVESTMENT_API}/operations`),
                    apiCall(`${INVESTMENT_API}/trigger-history`)
                ]);

                const twentyFourHoursAgo = Date.now() - 86400000;
                const newTriggers = triggerHistory.filter(item => {
                    const triggerTime = new Date(item.triggeredAt).getTime();
                    const triggerId = createTriggerId(item.operationId, item.securityTicker, item.triggeredAt);
                    return triggerTime > twentyFourHoursAgo && !sentNotifications.has(triggerId);
                });

                let sentCount = 0;
                for (const trigger of newTriggers) {
                    const operation = operations.find(op => op.id === trigger.operationId);
                    if (!operation) continue;

                    const emailToSend = operation.notificationEmail || getValue('opEmail') || 'kuzminovdaniil4@gmail.com';

                    // trigger.triggeredPrice для расчета
                    const calculation = await calculateOperationCost(operation, trigger.triggeredPrice);

                    // Добавляем исходную стоимость
                    const originalCost = (operation.quantity * operation.purchasePricePerShare + (operation.commission || 5.00)).toFixed(2);

                    const emailText = `СРОЧНОЕ УВЕДОМЛЕНИЕ!\n\n` +
                        `Акция: ${trigger.securityTicker}\n` +
                        `Целевая цена: $${trigger.targetPrice.toFixed(2)}\n` +
                        `Цена срабатывания: $${trigger.triggeredPrice.toFixed(2)}\n` +  
                        `Количество акций: ${operation.quantity} шт.\n` +
                        `Комиссия: $${(operation.commission || 5.00).toFixed(2)}\n` +
                        `ИТОГО: $${calculation.totalCost.toFixed(2)}\n\n` +
                        `${calculation.details || 'Расчет выполнен через Investment API'}\n\n` +
                        `Время срабатывания: ${new Date(trigger.triggeredAt).toLocaleString()}\n\n` +
                        `---\n` +
                        `Детали операции:\n` +
                        `• ID операции: #${operation.id}\n` +
                        `• Исходная цена покупки: $${operation.purchasePricePerShare?.toFixed(2) || 'Не указана'}\n` +
                        `• Исходная стоимость: $${originalCost}\n` +
                        `• Количество: ${operation.quantity} акций\n` +
                        `• Комиссия: $${(operation.commission || 5.00).toFixed(2)}\n` +
                        `---\n` +
                        `Это автоматическое уведомление.\n` +
                        `С уважением,\nИнвестиционная платформа`;

                    const emailResult = await sendEmailAPI(
                        emailToSend,
                        `ТРИГГЕР СРАБОТАЛ! ${trigger.securityTicker} - $${calculation.totalCost.toFixed(2)}`,
                        emailText
                    );

                    if (emailResult.success) {
                        sentCount++;
                        sentNotifications.add(createTriggerId(trigger.operationId, trigger.securityTicker, trigger.triggeredAt));
                        saveSentNotifications();
                        showToast(`Триггер ${trigger.securityTicker} сработал!`, 'success');
                    }

                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                showResult('triggersResult',
                    `ПРОВЕРКА ЗАВЕРШЕНА!\n\nНовых триггеров: ${newTriggers.length}\n` +
                    `Успешно отправлено: ${sentCount} писем\n` +
                    `Время: ${new Date().toLocaleString()}\n\n` +
                    `Всего отслеживаемых уведомлений: ${sentNotifications.size}`,
                    true
                );

                getActiveTriggers();
                getOperations();

            } catch (error) {
                showResult('triggersResult', `❌ Ошибка проверки: ${error.message}`, false);
            }
        };

        const getActiveTriggers = async () => {
            try {
                const triggers = await apiCall(`${INVESTMENT_API}/active-triggers`);
                const result = $('triggersResult');
                result.innerHTML = triggers?.length ? triggers.map(t => `
            <div class="notification">
                <strong>${t.securityTicker}</strong><br>${t.message}<br>
                <small>Цель: $${t.targetPrice} | Текущая: $${t.currentPrice}</small>
            </div>
        `).join('') : 'Нет активных триггеров';
                result.className = `result ${triggers?.length ? '' : 'success'}`;
            } catch (error) {
                console.error('Ошибка загрузки триггеров:', error);
            }
        };

        const getOperations = async () => {
            try {
                const data = await apiCall(`${INVESTMENT_API}/operations`);
                const result = $('operationsResult');
                result.innerHTML = data?.length ? data.map(op => {
                    // Находим информацию о срабатывании
                    const triggerInfo = op.triggeredAt ?
                        `Сработал: ${new Date(op.triggeredAt).toLocaleString()}` :
                        (op.isTriggered ? 'Статус: Ожидает' : 'Статус: Не сработал');

                    return `
                <div class="notification" style="margin-bottom: 10px;">
                    <strong>#${op.id} ${op.securityTicker}</strong><br>
                    Количество: ${op.quantity}шт<br>
                    Цена покупки: $${(op.purchasePricePerShare || 0).toFixed(2)}<br>
                    Комиссия: $${(op.commission || 0).toFixed(2)}<br>
                    Итого: $${(op.totalCost || 0).toFixed(2)}<br>
                    ${op.targetBuyPrice ? `Триггер: $${op.targetBuyPrice.toFixed(2)}` : 'Без триггера'}<br>
                    ${op.notificationEmail ? `Email: ${op.notificationEmail}` : 'Email не указан'}<br>
                    ${triggerInfo}
                </div>
            `;
                }).join('') : 'Нет операций';
                result.className = `result ${data?.length ? 'success' : ''}`;
            } catch (error) {
                console.error('Ошибка загрузки операций:', error);
            }
        };

        // ========== КАЛЬКУЛЯТОР ==========
        const calculate = async () => {
            const getNum = id => parseFloat($(id).value);
            const securityId = $('calcSecurityId').value;
            const quantity = getNum('calcQuantity');
            const price = getNum('calcCurrentPrice');

            if (!securityId || quantity <= 0 || price <= 0) {
                return showResult('calcResult', '❌ Проверьте введенные данные', false);
            }

            try {
                const result = await apiCall(`${INVESTMENT_API}/calculate`, {
                    method: 'POST',
                    body: JSON.stringify({
                        securityId: parseInt(securityId),
                        quantity: quantity,
                        purchasePricePerShare: price,
                        commission: getNum('calcCommission') || 5.00
                    })
                });

                const sec = securities.find(s => s.id == securityId);
                showResult('calcResult',
                    `<strong>${sec?.ticker}: $${(result.totalCost || 0).toFixed(2)}</strong><br>` +
                    `Количество: ${quantity} акций<br>Цена: $${price.toFixed(2)}<br>` +
                    `Комиссия: $${getNum('calcCommission').toFixed(2)}<br>${result.triggerMessage || ''}`,
                    true
                );
            } catch (error) {
                showResult('calcResult', '❌ Ошибка расчета через API', false);
            }
        };

        const clearNotificationsHistory = () => {
            if (confirm('Очистить историю отправленных уведомлений?')) {
                sentNotifications.clear();
                saveSentNotifications();
                showToast('История уведомлений очищена!', 'success');
                showResult('triggersResult', 'История очищена\nВсего отслеживаемых: 0', true);
            }
        };

        // ========== ИНИЦИАЛИЗАЦИЯ ==========
        document.addEventListener('DOMContentLoaded', () => {
            loadSentNotifications();
            cleanupOldNotifications();
            loadSecurities();
            getOperations();
            getActiveTriggers();
            checkServices();

            const savedEmail = localStorage.getItem('lastUsedEmail');
            if (savedEmail) $('opEmail').value = savedEmail;

            updatePricesInRealTime();
            setInterval(updatePricesInRealTime, 3000);
            setInterval(() => checkTriggersAndSendEmails(), 30000);
        });
    </script>
</body>
</html>
