 <!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Инвестиционная платформа</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .integration-flow {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .flow-step {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
        }

        .flow-number {
            background: white;
            color: #667eea;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }

        input, select, button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

            button:hover {
                background: #0056b3;
            }

        .result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f8f9fa;
            white-space: pre-line;
        }

        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .notification {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            color: #856404;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active {
            background: #28a745;
        }

        .status-inactive {
            background: #dc3545;
        }

        .api-status {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
        }

        .price-ticker {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: #fff;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .ticker-item {
            padding: 8px 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e9ecef;
            font-weight: bold;
        }

        .price-up {
            color: #28a745;
        }

        .price-down {
            color: #dc3545;
        }

        .tracking-info {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            color: #1565c0;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <h1>Инвестиционная платформа</h1>
    <div id="priceTicker" class="price-ticker"></div>

    <div class="integration-flow">
        <h3>Схема работы</h3>
        <div class="flow-step">
            <div class="flow-number">1</div>
            <div>Создайте операцию покупки акций с указанием email</div>
        </div>
        <div class="flow-step">
            <div class="flow-number">2</div>
            <div>Установите целевую цену для триггера</div>
        </div>
        <div class="flow-step">
            <div class="flow-number">3</div>
            <div>При срабатывании триггера письмо будет отправлено на указанный email</div>
        </div>
    </div>

    <div class="dashboard">
        <!-- Левая колонка -->
        <div>
            <div class="section">
                <h3>Статус сервисов</h3>
                <div class="api-status">
                    <span>Investment API:</span>
                    <span><span class="status-indicator" id="investmentStatusIndicator"></span> <span id="investmentStatusText">Проверка...</span></span>
                </div>
                <div class="api-status">
                    <span>Email Service:</span>
                    <span><span class="status-indicator" id="emailServiceStatusIndicator"></span> <span id="emailServiceStatusText">Проверка...</span></span>
                </div>
                <button onclick="checkServices()">Проверить статус</button>
            </div>

            <div class="section">
                <h3>Калькулятор операции</h3>
                <select id="calcSecurityId">
                    <option value="">Выберите бумагу</option>
                </select>
                <input type="number" id="calcQuantity" placeholder="Количество" value="10">
                <input type="number" id="calcCurrentPrice" placeholder="Текущая цена" step="0.01" readonly>
                <input type="number" id="calcCommission" placeholder="Комиссия" value="5.00" step="0.01">
                <button onclick="calculate()">Рассчитать стоимость</button>
                <div id="calcResult" class="result"></div>
            </div>
        </div>

        <!-- Правая колонка -->
        <div>
            <div class="section">
                <h3>Новая операция с уведомлением</h3>
                <div class="notification" style="margin-bottom: 15px;">
                    <strong>Важно:</strong> Email будет сохранен вместе с операцией и использован для уведомлений о триггерах
                </div>
                <select id="opSecurityId">
                    <option value="">Выберите бумагу</option>
                </select>
                <input type="number" id="opQuantity" placeholder="Количество" value="10">
                <input type="number" id="opPrice" placeholder="Цена покупки" step="0.01">
                <input type="number" id="opCommission" placeholder="Комиссия" value="5.00" step="0.01">
                <input type="number" id="opTargetPrice" placeholder="Целевая цена для триггера" step="0.01">
                <input type="email" id="opEmail" placeholder="Email для уведомления" value="kuzminovdaniil4@gmail.com">
                <button onclick="addOperationWithEmail()" style="background: #28a745;">Добавить операцию с уведомлением</button>
                <div id="opResult" class="result"></div>
            </div>

            <div class="section">
                <h3>Активные триггеры</h3>
                <div id="triggersInfo" class="notification" style="margin-bottom: 10px;">
                    Автопроверка: каждые 30 секунд<br>
                    При срабатывании: письмо на email из операции
                </div>

                <div id="trackingInfo" class="notification tracking-info" style="margin-bottom: 10px;">
                    <strong>Отслеживание уведомлений:</strong><br>
                    • Письма сохраняются в браузере на 24 часа<br>
                    • Все расчеты стоимости выполняются через Investment API<br>
                    • Всего отслеживается: <strong id="trackingCount">0</strong> уведомлений
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button onclick="getActiveTriggers()" style="flex: 1;">Обновить список</button>
                    <button onclick="checkTriggersAndSendEmails()" style="background: #28a745; flex: 1;">Проверить триггеры сейчас</button>
                </div>

                <div style="display: flex; gap: 10px;">

                    <button onclick="clearNotificationsHistory()" style="background: #9c27b0; flex: 1;">Очистить историю</button>
                </div>

                <div id="triggersResult" class="result"></div>
            </div>
        </div>
    </div>

    <div class="section">
        <h3>История операций</h3>
        <button onclick="getOperations()">Обновить историю</button>
        <div id="operationsResult" class="result"></div>
    </div>

    <script>
        const INVESTMENT_API = 'http://pr4-daniil465346.amvera.io/api/investment';
        const EMAIL_API = 'http://neapiemail2-daniil465346.amvera.io';
        let securities = [];
        let previousPrices = {};
        let autoRefreshEnabled = false;
        let priceUpdateInterval;
        let triggerCheckInterval;

        let sentNotifications = new Set();

        // ========== ФУНКЦИИ ДЛЯ РАБОТЫ С ЛОКАЛЬНЫМ ХРАНИЛИЩЕМ ==========

        function loadSentNotifications() {
            try {
                const saved = localStorage.getItem('sentNotifications');
                if (saved) {
                    const array = JSON.parse(saved);
                    sentNotifications = new Set(array);
                    console.log(`Загружено ${sentNotifications.size} отправленных уведомлений из localStorage`);
                    updateTrackingCount();
                }
            } catch (error) {
                console.error('Ошибка загрузки sentNotifications:', error);
                sentNotifications = new Set();
            }
        }

        function saveSentNotifications() {
            try {
                const array = Array.from(sentNotifications);
                localStorage.setItem('sentNotifications', JSON.stringify(array));
                console.log(`Сохранено ${sentNotifications.size} уведомлений в localStorage`);
                updateTrackingCount();
            } catch (error) {
                console.error('Ошибка сохранения sentNotifications:', error);
            }
        }

        function cleanupOldNotifications() {
            const twentyFourHoursAgo = Date.now() - 24 * 60 * 60 * 1000;
            const oldCount = sentNotifications.size;

            const filtered = Array.from(sentNotifications).filter(id => {
                const parts = id.split('_');
                if (parts.length < 4) return false;
                const timestamp = parseInt(parts[3]);
                return timestamp > twentyFourHoursAgo;
            });

            sentNotifications = new Set(filtered);
            saveSentNotifications();

            const removed = oldCount - sentNotifications.size;
            if (removed > 0) {
                console.log(`Очищено ${removed} старых уведомлений (старше 24 часов)`);
            }
        }

        function updateTrackingCount() {
            const countElement = document.getElementById('trackingCount');
            if (countElement) {
                countElement.textContent = sentNotifications.size;
            }
        }

        function createTriggerId(operationId, securityTicker, triggeredAt) {
            const time = new Date(triggeredAt).getTime();
            return `trigger_${operationId}_${securityTicker}_${time}`;
        }

        // ========== ФУНКЦИЯ ДЛЯ РАСЧЕТА СТОИМОСТИ ЧЕРЕЗ API ==========

        async function calculateOperationCost(operationData, currentPrice) {
            try {
                const response = await fetch(`${INVESTMENT_API}/calculate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        securityId: operationData.securityId,
                        quantity: operationData.quantity,
                        purchasePricePerShare: currentPrice,
                        commission: operationData.commission || 5.00,
                        targetBuyPrice: operationData.targetBuyPrice || null
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();

                if (!result.totalCost) {
                    const total = result.TotalCost || result.total || result.cost;
                    if (total) {
                        return {
                            totalCost: total,
                            hasTrigger: result.hasTrigger || false,
                            triggerMessage: result.triggerMessage || '',
                            calculatedWithApi: true,
                            details: result.details || ''
                        };
                    }
                    throw new Error('API не вернул totalCost');
                }

                return {
                    totalCost: result.totalCost,
                    hasTrigger: result.hasTrigger || false,
                    triggerMessage: result.triggerMessage || '',
                    calculatedWithApi: true,
                    details: result.details || ''
                };

            } catch (error) {
                console.error('Ошибка расчета через API:', error);

                if (operationData.totalCost) {
                    return {
                        totalCost: operationData.totalCost,
                        hasTrigger: !!operationData.targetBuyPrice,
                        triggerMessage: operationData.targetBuyPrice ?
                            `Триггер: $${operationData.targetBuyPrice}` : '',
                        calculatedWithApi: false,
                        details: 'Использованы данные из операции (API недоступен)'
                    };
                }

                throw error;
            }
        }

        // ========== ОСНОВНЫЕ ФУНКЦИИ ==========

        function showResult(elementId, message, isSuccess) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = message;
                element.className = `result ${isSuccess ? 'success' : 'error'}`;
            }
        }

        function showToastNotification(message, type = 'info') {
            const toast = document.createElement('div');
            toast.innerHTML = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                background: ${type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#2196f3'};
                color: white;
                border-radius: 5px;
                z-index: 1000;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ========== EMAIL ФУНКЦИИ ==========

        async function sendEmailAPI(toEmail, subject, message) {
            try {
                const response = await fetch(`${EMAIL_API}/sendEmail`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        toEmail: toEmail,
                        subject: subject,
                        text: message
                    })
                });

                if (response.status === 201 || response.status === 200) {
                    return { success: true, message: 'Письмо отправлено' };
                } else {
                    const errorText = await response.text();
                    return { success: false, message: `Ошибка ${response.status}: ${errorText}` };
                }
            } catch (error) {
                console.error('Email API error:', error);
                return { success: false, message: `Сетевая ошибка: ${error.message}` };
            }
        }

        // ========== ЗАГРУЗКА ДАННЫХ ==========

        async function loadSecurities() {
            try {
                const response = await fetch(`${INVESTMENT_API}/securities`);
                securities = await response.json();

                const calcSelect = document.getElementById('calcSecurityId');
                const opSelect = document.getElementById('opSecurityId');

                calcSelect.innerHTML = '<option value="">Выберите бумагу</option>';
                opSelect.innerHTML = '<option value="">Выберите бумагу</option>';

                securities.forEach(security => {
                    const optionText = `${security.ticker} - $${security.currentPrice}`;

                    const calcOption = document.createElement('option');
                    calcOption.value = security.id;
                    calcOption.textContent = optionText;
                    calcSelect.appendChild(calcOption);

                    const opOption = document.createElement('option');
                    opOption.value = security.id;
                    opOption.textContent = optionText;
                    opSelect.appendChild(opOption);
                });

                console.log(`Загружено бумаг: ${securities.length}`);

                calcSelect.addEventListener('change', updatePriceOnSelect);
                opSelect.addEventListener('change', updatePriceOnSelect);

            } catch (error) {
                console.error('Ошибка загрузки бумаг:', error);
            }
        }

        function updatePriceOnSelect() {
            const selectElement = this;
            const securityId = selectElement.value;

            if (!securityId) return;

            const security = securities.find(s => s.id == securityId);
            if (security) {
                if (selectElement.id === 'calcSecurityId') {
                    document.getElementById('calcCurrentPrice').value = security.currentPrice;
                } else if (selectElement.id === 'opSecurityId') {
                    document.getElementById('opPrice').value = security.currentPrice;
                }
            }
        }

        // ========== ОБНОВЛЕНИЕ ЦЕН В РЕАЛЬНОМ ВРЕМЕНИ ==========
        async function updatePricesInRealTime() {
            try {
                const response = await fetch(`${INVESTMENT_API}/current-prices`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status} при запросе current-prices`);
                }
                const data = await response.json();

                const priceItems = data.Prices || data.prices || [];

                const updatedSecurities = priceItems.map(p => ({
                    id: p.Id || p.id,
                    ticker: p.Ticker || p.ticker,
                    currentPrice: Number((p.CurrentPrice || p.currentPrice || 0).toFixed(2))
                }));

                // Обновляем глобальный массив securities
                updatedSecurities.forEach(upd => {
                    const existing = securities.find(s => s.id == upd.id);
                    if (existing) {
                        existing.currentPrice = upd.currentPrice;
                    } else {
                        securities.push({
                            id: upd.id,
                            ticker: upd.ticker,
                            name: upd.name || '',
                            currentPrice: upd.currentPrice
                        });
                    }
                });

                // Обновляем визуальный ticker
                const tickerEl = document.getElementById('priceTicker');
                if (tickerEl) {
                    tickerEl.innerHTML = securities.map(sec =>
                        `<div class="ticker-item">${sec.ticker}: $${Number(sec.currentPrice).toFixed(2)}</div>`
                    ).join('');
                }

                // Обновляем выпадающие списки и поля цен
                updateDropdownPrices();
                updateSelectedPriceFields();

            } catch (error) {
                console.error('Ошибка обновления цен:', error);
                const tickerEl = document.getElementById('priceTicker');
                if (tickerEl) {
                    tickerEl.innerHTML = `<div class="notification">Ошибка обновления цен: ${error.message}</div>`;
                }
            }
        }

        function updateDropdownPrices() {
            const calcSelect = document.getElementById('calcSecurityId');
            const opSelect = document.getElementById('opSecurityId');

            if (!calcSelect || !opSelect) return;

            const calcSelectedValue = calcSelect.value;
            const opSelectedValue = opSelect.value;

            Array.from(calcSelect.options).forEach(option => {
                if (option.value) {
                    const security = securities.find(s => s.id == option.value);
                    if (security) {
                        option.textContent = `${security.ticker} - $${security.currentPrice}`;
                    }
                }
            });

            Array.from(opSelect.options).forEach(option => {
                if (option.value) {
                    const security = securities.find(s => s.id == option.value);
                    if (security) {
                        option.textContent = `${security.ticker} - $${security.currentPrice}`;
                    }
                }
            });

            calcSelect.value = calcSelectedValue;
            opSelect.value = opSelectedValue;
        }

        function updateSelectedPriceFields() {
            const calcSelect = document.getElementById('calcSecurityId');
            const opSelect = document.getElementById('opSecurityId');

            if (calcSelect && calcSelect.value) {
                const security = securities.find(s => s.id == calcSelect.value);
                const priceField = document.getElementById('calcCurrentPrice');
                if (security && priceField) {
                    priceField.value = security.currentPrice;
                }
            }

            if (opSelect && opSelect.value) {
                const security = securities.find(s => s.id == opSelect.value);
                const priceField = document.getElementById('opPrice');
                if (security && priceField) {
                    priceField.value = security.currentPrice;
                }
            }
        }

        // ========== ОПЕРАЦИИ И ТРИГГЕРЫ ==========

        async function addOperationWithEmail() {
            const securityId = document.getElementById('opSecurityId').value;
            const quantity = document.getElementById('opQuantity').value;
            const price = document.getElementById('opPrice').value;
            const commission = document.getElementById('opCommission').value;
            const targetPrice = document.getElementById('opTargetPrice').value;
            const email = document.getElementById('opEmail').value.trim();

            if (!securityId) return showResult('opResult', '❌ Выберите бумагу', false);
            if (!email || !email.includes('@')) return showResult('opResult', '❌ Введите корректный email', false);
            if (!quantity || quantity <= 0) return showResult('opResult', '❌ Введите корректное количество', false);
            if (!price || price <= 0) return showResult('opResult', '❌ Введите корректную цену', false);

            const operation = {
                securityId: parseInt(securityId),
                quantity: parseInt(quantity),
                purchasePricePerShare: parseFloat(price),
                commission: parseFloat(commission),
                targetBuyPrice: targetPrice ? parseFloat(targetPrice) : null,
                notificationEmail: email
            };

            try {
                showResult('opResult', 'Создаем операцию...', true);

                const response = await fetch(`${INVESTMENT_API}/operation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(operation)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();

                let message = 'Операция успешно создана!\n\n';
                const security = securities.find(s => s.id == securityId);
                if (security) {
                    message += `Бумага: ${security.ticker}\n`;
                }
                message += `Количество: ${quantity} акций\n`;
                message += `Цена покупки: $${parseFloat(price).toFixed(2)}\n`;
                message += `Комиссия: $${parseFloat(commission).toFixed(2)}\n`;

                if (targetPrice) {
                    message += `Триггер: $${parseFloat(targetPrice).toFixed(2)}\n`;
                    message += `Email для уведомлений: ${email}\n\n`;
                    message += `При срабатывании триггера письмо придет на этот email!\n`;
                }

                showResult('opResult', message, true);

                localStorage.setItem('lastUsedEmail', email);
                getOperations();
                getActiveTriggers();

            } catch (error) {
                console.error('Ошибка создания операции:', error);
                showResult('opResult', `❌ Ошибка: ${error.message}`, false);
            }
        }

        async function markTriggerAsProcessed(triggerId) {
            try {
                await fetch(`${INVESTMENT_API}/mark-processed/${triggerId}`, {
                    method: 'POST'
                });
            } catch (error) {
                console.error('Ошибка отметки триггера:', error);
            }
        }

        async function checkTriggersAndSendEmails() {
            try {
                showResult('triggersResult', 'Проверяем триггеры и отправляем уведомления...', true);

                const operationsResponse = await fetch(`${INVESTMENT_API}/operations`);
                if (!operationsResponse.ok) throw new Error('Не удалось получить операции');
                const operations = await operationsResponse.json();

                const historyResponse = await fetch(`${INVESTMENT_API}/trigger-history`);
                const triggerHistory = await historyResponse.json();

                let sentCount = 0;
                const newTriggers = [];
                const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);

                for (const historyItem of triggerHistory) {
                    const triggerTime = new Date(historyItem.triggeredAt);

                    if (triggerTime > twentyFourHoursAgo) {
                        const triggerId = createTriggerId(
                            historyItem.operationId,
                            historyItem.securityTicker,
                            historyItem.triggeredAt
                        );

                        if (!sentNotifications.has(triggerId)) {
                            newTriggers.push({
                                ...historyItem,
                                triggerId: triggerId,
                                triggerTime: triggerTime
                            });
                        }
                    }
                }

                if (newTriggers.length > 0) {
                    for (const trigger of newTriggers) {
                        try {
                            const operation = operations.find(op => op.id === trigger.operationId);
                            const emailToSend = operation?.notificationEmail ||
                                                document.getElementById('opEmail').value.trim() ||
                                                'kuzminovdaniil4@gmail.com';

                            if (!operation) {
                                console.log(`Не найдена операция для триггера ${trigger.operationId}`);
                                continue;
                            }

                            let calculation;
                            try {
                                calculation = await calculateOperationCost(
                                    {
                                        securityId: operation.securityId,
                                        quantity: operation.quantity,
                                        commission: operation.commission || 5.00,
                                        targetBuyPrice: operation.targetBuyPrice,
                                        totalCost: operation.totalCost
                                    },
                                    trigger.triggeredPrice
                                );
                            } catch (calcError) {
                                calculation = {
                                    totalCost: operation.totalCost || (operation.quantity * trigger.triggeredPrice + (operation.commission || 5.00)),
                                    hasTrigger: !!operation.targetBuyPrice,
                                    triggerMessage: operation.targetBuyPrice ? `Триггер: $${operation.targetBuyPrice}` : '',
                                    calculatedWithApi: false,
                                    details: 'Расчет на основе данных операции (API недоступен)'
                                };
                            }

                            const emailText = `СРОЧНОЕ УВЕДОМЛЕНИЕ!\n\n` +
                                `Акция: ${trigger.securityTicker}\n` +
                                `Целевая цена: $${trigger.targetPrice.toFixed(2)}\n` +
                                `Цена срабатывания: $${trigger.triggeredPrice.toFixed(2)}\n` +
                                `Количество акций: ${operation.quantity} шт.\n` +
                                `Комиссия: $${(operation.commission || 5.00).toFixed(2)}\n` +
                                `ИТОГО: $${calculation.totalCost.toFixed(2)}\n\n` +
                                `${calculation.details || 'Расчет выполнен через Investment API'}\n\n` +
                                `Время срабатывания: ${trigger.triggerTime.toLocaleString()}\n\n` +
                                `---\n` +
                                `Детали операции:\n` +
                                `• ID операции: #${operation.id}\n` +
                                `• Исходная цена покупки: $${operation.purchasePricePerShare?.toFixed(2) || 'Не указана'}\n` +
                                `• Исходная стоимость: $${(operation.totalCost || (operation.quantity * operation.purchasePricePerShare + (operation.commission || 5.00))).toFixed(2)}\n` +
                                `• Количество: ${operation.quantity} акций\n` +
                                `• Комиссия: $${(operation.commission || 5.00).toFixed(2)}\n` +
                                `---\n` +
                                `Это автоматическое уведомление.\n` +
                                `С уважением,\nИнвестиционная платформа`;

                            const emailResult = await sendEmailAPI(
                                emailToSend,
                                `ТРИГГЕР СРАБОТАЛ! ${trigger.securityTicker} - $${calculation.totalCost.toFixed(2)}`,
                                emailText
                            );

                            if (emailResult.success) {
                                sentCount++;
                                sentNotifications.add(trigger.triggerId);
                                saveSentNotifications();

                                if (trigger.id) {
                                    await markTriggerAsProcessed(trigger.id);
                                }

                                showToastNotification(
                                    `Триггер ${trigger.securityTicker} сработал!\n` +
                                    `Стоимость: $${calculation.totalCost.toFixed(2)}\n` +
                                    `Письмо отправлено на ${emailToSend}`,
                                    'success'
                                );
                            }

                            await new Promise(resolve => setTimeout(resolve, 500));

                        } catch (triggerError) {
                            console.error(`Ошибка обработки триггера ${trigger.securityTicker}:`, triggerError);
                        }
                    }

                    showResult('triggersResult',
                        `ПРОВЕРКА ЗАВЕРШЕНА!\n\n` +
                        `Найдено новых триггеров: ${newTriggers.length}\n` +
                        `Успешно отправлено: ${sentCount} писем\n` +
                        `Время: ${new Date().toLocaleString()}\n\n` +
                        `Всего отслеживаемых уведомлений: ${sentNotifications.size}`,
                        true
                    );

                    getActiveTriggers();
                    getOperations();

                } else {
                    showResult('triggersResult',
                        `Проверка завершена\n\n` +
                        `Новых триггеров: 0\n` +
                        `Всего отслеживаемых уведомлений: ${sentNotifications.size}\n` +
                        `Время: ${new Date().toLocaleString()}\n` +
                        `Все триггеры обработаны!`,
                        true
                    );
                }

            } catch (error) {
                console.error('Критическая ошибка проверки:', error);
                showResult('triggersResult', `❌ Ошибка проверки: ${error.message}`, false);
            }
        }

        async function getActiveTriggers() {
            try {
                const response = await fetch(`${INVESTMENT_API}/active-triggers`);
                const triggers = await response.json();

                const result = document.getElementById('triggersResult');
                if (triggers && triggers.length > 0) {
                    result.innerHTML = triggers.map(t => `
                        <div class="notification">
                            <strong>${t.securityTicker}</strong><br>
                            ${t.message}<br>
                            <small>Цель: $${t.targetPrice} | Текущая: $${t.currentPrice}</small>
                        </div>
                    `).join('');
                } else {
                    result.innerHTML = 'Нет активных триггеров';
                    result.className = 'result success';
                }
            } catch (error) {
                console.error('Ошибка загрузки триггеров:', error);
            }
        }

        async function getOperations() {
            try {
                const response = await fetch(`${INVESTMENT_API}/operations`);
                const data = await response.json();

                const result = document.getElementById('operationsResult');
                if (data && data.length > 0) {
                    result.innerHTML = data.map(op => `
                        <div class="notification" style="margin-bottom: 10px;">
                            <strong>#${op.id} ${op.securityTicker}</strong><br>
                            ${op.quantity}шт × $${op.purchasePricePerShare?.toFixed(2) || '0.00'}<br>
                            Итого: $${op.totalCost?.toFixed(2) || '0.00'}<br>
                            ${op.targetBuyPrice ? `Триггер: $${op.targetBuyPrice.toFixed(2)}` : 'Без триггера'}<br>
                            ${op.notificationEmail ? `Email: ${op.notificationEmail}` : 'Email не указан'}<br>
                            ${op.isTriggered ? `Сработал: ${new Date(op.triggeredAt).toLocaleString()}` : 'Ожидает'}
                        </div>
                    `).join('');
                    result.className = 'result success';
                } else {
                    result.innerHTML = 'Нет операций';
                    result.className = 'result';
                }
            } catch (error) {
                console.error('Ошибка загрузки операций:', error);
            }
        }

        // ========== КАЛЬКУЛЯТОР ==========

        async function calculate() {
            const securityId = document.getElementById('calcSecurityId').value;
            const quantity = document.getElementById('calcQuantity').value;
            const price = document.getElementById('calcCurrentPrice').value;
            const commission = document.getElementById('calcCommission').value;

            if (!securityId) return showResult('calcResult', '❌ Выберите бумагу', false);
            if (!quantity || quantity <= 0) return showResult('calcResult', '❌ Введите корректное количество', false);
            if (!price || price <= 0) return showResult('calcResult', '❌ Введите корректную цену', false);

            try {
                const response = await fetch(`${INVESTMENT_API}/calculate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        securityId: parseInt(securityId),
                        quantity: parseInt(quantity),
                        purchasePricePerShare: parseFloat(price),
                        commission: parseFloat(commission)
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                const security = securities.find(s => s.id == securityId);

                document.getElementById('calcResult').innerHTML =
                    `<strong>${security.ticker}: $${result.totalCost?.toFixed(2) || 'Ошибка расчета'}</strong><br>
                     Количество: ${quantity} акций<br>
                     Цена за акцию: $${parseFloat(price).toFixed(2)}<br>
                     Комиссия: $${parseFloat(commission).toFixed(2)}<br>
                     Итого (API): $${result.totalCost?.toFixed(2) || 'Ошибка'}<br>
                     ${result.triggerMessage ? `${result.triggerMessage}` : ''}<br>
                     <small>Расчет выполнен через Investment API</small>`;
                document.getElementById('calcResult').className = 'result success';

            } catch (error) {
                console.error('Ошибка расчета через API:', error);
                document.getElementById('calcResult').innerHTML =
                    `<strong>❌ Ошибка расчета через API</strong><br>
                     Количество: ${quantity} акций<br>
                     Цена за акцию: $${parseFloat(price).toFixed(2)}<br>
                     Комиссия: $${parseFloat(commission).toFixed(2)}<br>
                     Итого: Ошибка API<br>
                     <small>❌ Investment API недоступен. Повторите попытку позже.</small>`;
                document.getElementById('calcResult').className = 'result error';
            }
        }

        // ========== СТАТУС СЕРВИСОВ ==========

        async function checkServices() {
            try {
                const investmentResponse = await fetch(`${INVESTMENT_API}/securities`);
                const investmentOk = investmentResponse.ok;
                document.getElementById('investmentStatusIndicator').className = `status-indicator ${investmentOk ? 'status-active' : 'status-inactive'}`;
                document.getElementById('investmentStatusText').textContent = investmentOk ? 'Online' : 'Offline';

                const fixedEmail = 'kuzminovdaniil4@gmail.com';  
                const testData = { toEmail: fixedEmail, subject: "Status Check", text: "Service status check" };
                const emailResponse = await fetch(`${EMAIL_API}/sendEmail`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                const emailOk = emailResponse.status === 201 || emailResponse.ok;
                document.getElementById('emailServiceStatusIndicator').className = `status-indicator ${emailOk ? 'status-active' : 'status-inactive'}`;
                document.getElementById('emailServiceStatusText').textContent = emailOk ? 'Online' : 'Offline';

                if (investmentOk && emailOk) {
                    showToastNotification('Все сервисы работают корректно!', 'success');
                } else {
                    showToastNotification('Некоторые сервисы недоступны', 'error');
                }
            } catch (error) {
                document.getElementById('investmentStatusIndicator').className = 'status-indicator status-inactive';
                document.getElementById('investmentStatusText').textContent = 'Offline';
                document.getElementById('emailServiceStatusIndicator').className = 'status-indicator status-inactive';
                document.getElementById('emailServiceStatusText').textContent = 'Offline';
                showToastNotification('❌ Ошибка проверки статуса', 'error');
            }
        }


        // ========== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ==========

        function startAutoTriggerCheck() {
            console.log('Автопроверка триггеров запущена (каждые 30 секунд)');

            if (triggerCheckInterval) {
                clearInterval(triggerCheckInterval);
            }

            setTimeout(() => {
                checkTriggersAndSendEmails();
            }, 5000);

            triggerCheckInterval = setInterval(() => {
                checkTriggersAndSendEmails();
            }, 30000);
        }

        async function forceCheckTriggers() {
            console.log('Принудительная проверка триггеров');
            cleanupOldNotifications();
            await checkTriggersAndSendEmails();
        }

        function clearNotificationsHistory() {
            const confirmed = confirm('Вы уверены, что хотите очистить историю отправленных уведомлений?\n\nЭто может привести к повторной отправке писем для старых триггеров.');

            if (confirmed) {
                sentNotifications.clear();
                saveSentNotifications();
                showToastNotification('История отправленных уведомлений очищена!', 'success');

                showResult('triggersResult',
                    `ИСТОРИЯ ОЧИЩЕНА\n\n` +
                    `История отправленных уведомлений удалена\n` +
                    `Теперь отслеживается: 0 уведомлений\n` +
                    `Время: ${new Date().toLocaleString()}\n\n` +
                    `Следующая проверка отправит письма для всех неотправленных триггеров.`,
                    true
                );
            }
        }

        // ========== ЗАПУСК ПРИЛОЖЕНИЯ ==========

        document.addEventListener('DOMContentLoaded', function () {
            console.log('Инвестиционная платформа запущена!');

            loadSentNotifications();
            cleanupOldNotifications();

            loadSecurities();
            getOperations();
            getActiveTriggers();
            checkServices();

            const savedEmail = localStorage.getItem('lastUsedEmail');
            if (savedEmail) {
                document.getElementById('opEmail').value = savedEmail;
            }

            updatePricesInRealTime();
            setInterval(updatePricesInRealTime, 30000);

            startAutoTriggerCheck();

            console.log(`Приложение полностью загружено`);
            console.log(`Отслеживаем отправленных уведомлений: ${sentNotifications.size}`);
        });
    </script>
</body>
</html>
